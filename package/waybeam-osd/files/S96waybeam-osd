#!/bin/sh
# Simple control script for waybeam-osd (no start-stop-daemon, no PID files)

DAEMON_NAME="waybeam-osd"
DAEMON_PATH="/usr/bin/waybeam-osd"
DAEMON_CONF="/etc/waybeam_osd.json"

# Try to find PIDs using pidof, fall back to pgrep
get_pids() {
    if command -v pidof >/dev/null 2>&1; then
        pidof "$DAEMON_NAME"
    else
        # -x to match exact name, -f to match full cmdline if needed
        pgrep -x "$DAEMON_NAME" || pgrep -f "^${DAEMON_PATH}[ ]" || pgrep -f "^${DAEMON_NAME}[ ]"
    fi
}

is_running() {
    [ -n "$(get_pids)" ]
}

start() {
    if is_running; then
        echo "$DAEMON_NAME already running (PIDs: $(get_pids))"
        return 0
    fi

    echo -n "Starting $DAEMON_NAME: "
    "$DAEMON_PATH" "$DAEMON_CONF" >/dev/null 2>&1 &
    # Give it a moment to spawn
    sleep 0.2

    if is_running; then
        echo "OK (PIDs: $(get_pids))"
        return 0
    else
        echo "FAIL"
        return 1
    fi
}

stop() {
    if ! is_running; then
        echo "$DAEMON_NAME is not running"
        return 0
    fi

    echo -n "Stopping $DAEMON_NAME: "
    PIDS="$(get_pids)"
    # Try graceful TERM first
    kill $PIDS 2>/dev/null

    # Wait briefly, then escalate if needed
    for _ in 1 2 3 4 5; do
        sleep 0.2
        is_running || { echo "OK"; return 0; }
    done

    # If still running, SIGKILL
    kill -9 $(get_pids) 2>/dev/null
    sleep 0.2
    if is_running; then
        echo "FAIL"
        return 1
    else
        echo "OK"
        return 0
    fi
}

reload() {
    if ! is_running; then
        echo "$DAEMON_NAME is not running"
        return 1
    fi
    echo -n "Reloading $DAEMON_NAME (SIGHUP): "
    kill -HUP $(get_pids) 2>/dev/null && echo "OK" || echo "FAIL"
}

case "$1" in
    start)   start ;;
    stop)    stop ;;
    restart) stop; sleep 1; start ;;
    reload)  reload ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload}"
        exit 1
        ;;
esac
