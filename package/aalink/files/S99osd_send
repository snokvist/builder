#!/bin/sh
# Simple control script for osd_send watch (no start-stop-daemon, no PID files)

DAEMON="osd_send"

# What we actually want to run:
#   osd_send watch --texts '0="RSSI"' --values '0=@used_rssi'
#ARGS='watch --interval 125 --ini /tmp/aalink_ext.msg --ini /tmp/crsf_log.msg --texts '0="RSSI"' --values 0=@used_rssi,1=@rx_pps'
ARGS='watch --interval 100 --8812eu wlan0 --values 0=@rssi_a,1=@rssi_b'

# Find PIDs by matching the full command line (since "watch" is an arg, not a separate binary)
get_pids() {
    if command -v pgrep >/dev/null 2>&1; then
        # Match: osd_send watch ...
        pgrep -f "^${DAEMON}[[:space:]]+watch([[:space:]]|$)" 2>/dev/null
    elif command -v pidof >/dev/null 2>&1; then
        # Fallback: pidof only matches by process name (may be less precise)
        pidof "$DAEMON"
    else
        return 0
    fi
}

is_running() {
    [ -n "$(get_pids)" ]
}

start() {
    if is_running; then
        echo "$DAEMON already running (PIDs: $(get_pids))"
        return 0
    fi

    echo -n "Starting $DAEMON: "
    # shellcheck disable=SC2086
    "$DAEMON" $ARGS >/dev/null 2>&1 &
    sleep 0.2

    if is_running; then
        echo "OK (PIDs: $(get_pids))"
        return 0
    else
        echo "FAIL"
        return 1
    fi
}

stop() {
    if ! is_running; then
        echo "$DAEMON is not running"
        return 0
    fi

    echo -n "Stopping $DAEMON: "
    PIDS="$(get_pids)"

    kill $PIDS 2>/dev/null

    for _ in 1 2 3 4 5; do
        sleep 0.2
        is_running || { echo "OK"; return 0; }
    done

    kill -9 $(get_pids) 2>/dev/null
    sleep 0.2

    if is_running; then
        echo "FAIL"
        return 1
    else
        echo "OK"
        return 0
    fi
}

reload() {
    if ! is_running; then
        echo "$DAEMON is not running"
        return 1
    fi
    echo -n "Reloading $DAEMON (SIGHUP): "
    kill -HUP $(get_pids) 2>/dev/null && echo "OK" || echo "FAIL"
}

case "$1" in
    start)   start ;;
    stop)    stop ;;
    restart) stop; sleep 1; start ;;
    reload)  reload ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload}"
        exit 1
        ;;
esac

